import{d as e,ae as a,b as s,r as l,B as t,ac as r,W as o,aH as u,aD as i,a9 as n,e as p,f as d,g as c,h as f,w as m,n as g,p as v,F as y,N as h,V as x,E as _,D as b,v as k,ax as j,j as z,ay as S,O as A,k as D,t as T,q as B,x as C}from"./index-Dlau7bkh.js";import{_ as O}from"./cl-progress.C2FiTJd5.js";import{k as R,p as V}from"./cl-page.C3y_EXfh.js";import{b as w}from"./index.AbH2Jzti.js";import{_ as U}from"./_plugin-vue_export-helper.BCo6x5W8.js";const F=U(e({name:"cl-upload",props:{modelValue:[String,Array],text:{type:String,default:a("上传/拍摄")},sizeType:{type:[String,Array],default:()=>["original","compressed"]},sourceType:{type:Array,default:()=>["album","camera"]},size:{type:Array,default:()=>[200,200]},imageMode:{type:String,default:"aspectFill"},multiple:Boolean,limit:{type:Number,default:9},action:String,headers:Object,data:Object,name:{type:String,default:"file"},disabled:{type:Boolean,default:null},autoUpload:{type:Boolean,default:!0},test:Boolean},emits:["update:modelValue","change","exceed","success","error","upload","remove","progress"],setup(e,{emit:a}){const{t:p}=s(),{disabled:d}=R(),c=l([]),f=l(),m=t((()=>d.value||e.disabled));r((()=>e.modelValue),(e=>{if(e){const a=c.value,s=n(e)?e:e.split(",");c.value=s.map((e=>{const s=a.find((a=>a.url==e));return{uid:s?s.uid:i(),url:e,progress:100}})).filter((e=>e.url))}else c.value=[]}),{immediate:!0});const g=t((()=>{const a=c.value.length;return m.value?0==a:a<(e.multiple?e.limit:1)}));function v(e,a){const s=c.value.find((a=>a.uid==e));s&&(Object.assign(s,a),100==s.progress&&x())}function y(e){if(d.value)return!1;c.value.splice(e,1),a("remove",e),x()}function h(){return c.value.find((e=>100!=e.progress))}function x(){var s;if(!h()){const l=e.multiple?c.value.map((e=>e.url)):null==(s=c.value[0])?void 0:s.url;a("update:modelValue",l),a("change",l)}}return{isDisabled:m,list:c,index:f,isAppend:g,check:h,choose:function(s){if(m.value)return!1;f.value=s;const l=void 0===f.value?e.limit-c.value.length:1;if(l<=0)return a("exceed",c.value),!1;o({sizeType:e.sizeType,sourceType:e.sourceType,count:l,success(s){s.tempFiles.forEach((async s=>{const l=function(e){let a={};void 0!==f.value?(a=c.value[f.value],a.progress=0,a.url=e):(a={uid:i(),url:e,progress:0},c.value.push(a));return a.uid}(s.path);function t(e){e?(v(l,{url:e,progress:100}),a("success",e,s)):r()}function r(e=p("图片地址错误")){a("error",e),y(c.value.findIndex((e=>e.uid==l)))}if(e.test)return t(s.path);if(e.action){u({url:e.action||"",filePath:s.path,name:e.name,header:e.headers,formData:e.data,success:e=>{const{data:a}=JSON.parse(e.data);t(a)},fail:r}).onProgressUpdate((e=>{a("progress",e)}))}else e.autoUpload?w(s,{onProgressUpdate:({progress:e})=>{v(l,{progress:e})}}).then(t).catch(r):a("upload",{file:s,done:t,fail:r,update:v,uid:l})}))}})},update:v,remove:y,parseRpx:V}}}),[["render",function(e,a,s,l,t,r){const o=B,u=C,i=p(d("cl-progress"),O),n=k;return c(),f(n,{class:b(["cl-upload-list",[{"is-disabled":e.isDisabled}]])},{default:m((()=>[(c(!0),g(y,null,v(e.list,((a,s)=>(c(),f(n,{class:"cl-upload",key:a.uid,style:h({height:e.parseRpx(e.size[0]),width:e.parseRpx(e.size[1])}),onClick:a=>e.choose(s)},{default:m((()=>[j(z(o,{class:"cl-upload__target",src:a.url,mode:e.imageMode},null,8,["src","mode"]),[[S,a.url]]),e.isDisabled?_("",!0):(c(),f(u,{key:0,class:"cl-upload__remove cl-icon-toast-error",onClick:A((a=>e.remove(s)),["stop"])},null,8,["onClick"])),a.progress<100?(c(),f(n,{key:1,class:"cl-upload__progress"},{default:m((()=>[z(i,{value:a.progress,"show-text":!1},null,8,["value"])])),_:2},1024)):_("",!0)])),_:2},1032,["style","onClick"])))),128)),e.isAppend?(c(),f(n,{key:0,class:"cl-upload",style:h({height:e.parseRpx(e.size[0]),width:e.parseRpx(e.size[1])}),onClick:a[0]||(a[0]=a=>e.choose())},{default:m((()=>[x(e.$slots,"default",{},(()=>[z(n,{class:"cl-upload__demo"},{default:m((()=>[z(u,{class:"cl-icon-camera-fill"}),e.text?(c(),f(u,{key:0,class:"text"},{default:m((()=>[D(T(e.text),1)])),_:1})):_("",!0)])),_:1})]))])),_:3},8,["style"])):_("",!0)])),_:3},8,["class"])}]]);export{F as _};
