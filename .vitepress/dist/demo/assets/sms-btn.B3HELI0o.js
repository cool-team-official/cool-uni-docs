import{b as e,_ as a,d as s,c as o}from"./cl-page.CV4Clf1q.js";import{d as t,A as l,f as n,c as i,k as c,l as d,o as u,a as r,w as p,r as f,p as h,s as m,q as g,i as b,H as v,t as _}from"./index-CYp4B_QH.js";import{_ as w}from"./cl-text.0zcdGoXY.js";import{_ as x}from"./cl-input.BQlHe_GP.js";import{u as z,_ as k}from"./_plugin-vue_export-helper.C5tT7wvf.js";import{u as y}from"./index.CS5AuKI6.js";const C=k(t({__name:"sms-btn",props:{phone:String,type:String,height:Number,fontSize:Number,size:String,border:{type:Boolean,default:!0},plain:Boolean},emits:["success"],setup(t,{expose:k,emit:C}){const I=t,j=C,{service:S,refs:T,setRefs:V}=z(),$=y(),B=l({visible:!1,loading:!1,sending:!1,img:""}),F=n(0),N=i((()=>F.value>0||!I.phone)),U=i((()=>F.value>0?`${F.value}s后重新获取`:"获取验证码")),q=l({code:"",captchaId:""});function A(){function e(){F.value--,F.value<1&&clearInterval(a)}F.value=60;const a=setInterval(e,1e3);e()}async function E(){q.code?(B.sending=!0,await S.user.login.smsCode({phone:I.phone,...q}).then((()=>{$.showToast("短信已发送，请查收"),A(),D(),j("success")})).catch((e=>{$.showToast(e.message),H()})),B.sending=!1):$.showToast("请填写验证码")}async function H(){G(),B.loading=!0,await S.user.login.captcha({type:"png",color:"#000000",phone:I.phone}).then((e=>{q.captchaId=e.captchaId,B.img=e.data})).catch((e=>{$.showToast(e.message)})),B.loading=!1}function R(){I.phone&&(/^(?:(?:\+|00)86)?1[3-9]\d{9}$/.test(I.phone)?(B.visible=!0,H()):$.showToast("请填写正确的手机号格式"))}function D(){B.visible=!1,G()}function G(){q.code="",q.captchaId=""}return k({open:R,send:E,getCaptcha:H,startCountdown:A}),(l,n)=>{const i=c(d("cl-button"),e),z=c(d("cl-text"),w),k=c(d("cl-icon"),a),y=b,C=c(d("cl-input"),x),I=v,j=c(d("cl-loading-mask"),s),S=c(d("cl-popup"),o);return u(),r(y,{class:"sms-btn"},{default:p((()=>[f(l.$slots,"default",{disabled:N.value,countdown:F.value,btnText:U.value},(()=>[h(i,{border:!1,"background-color":"transparent",color:"#FE6B03",height:t.height,"font-size":t.fontSize,fill:"",size:t.size,disabled:N.value,onClick:R},{default:p((()=>[g(_(U.value),1)])),_:1},8,["height","font-size","size","disabled"])]),!0),h(S,{modelValue:B.visible,"onUpdate:modelValue":n[1]||(n[1]=e=>B.visible=e),ref:m(V)("popup"),padding:40,"border-radius":"24rpx"},{default:p((()=>[h(j,{loading:B.loading},{default:p((()=>[h(y,{class:"sms-popup"},{default:p((()=>[h(y,{class:"head"},{default:p((()=>[h(z,{bold:"",size:28,value:"获取短信验证码"}),h(k,{size:32,name:"close",onClick:D})])),_:1}),h(y,{class:"row"},{default:p((()=>{var e;return[h(C,{type:"number",modelValue:q.code,"onUpdate:modelValue":n[0]||(n[0]=e=>q.code=e),placeholder:"验证码",maxlength:4,height:70,clearable:!1,focus:null==(e=m(T).popup)?void 0:e.isFocus,border:!1,"background-color":"#f7f7f7",onConfirm:E},null,8,["modelValue","focus"]),h(I,{src:B.img,mode:"aspectFit",onClick:H},null,8,["src"])]})),_:1}),h(i,{type:"primary",fill:"",disabled:!q.code,loading:B.sending,height:70,onClick:E},{default:p((()=>[g(" 发送短信 ")])),_:1},8,["disabled","loading"])])),_:1})])),_:1},8,["loading"])])),_:1},8,["modelValue"])])),_:3})}}}),[["__scopeId","data-v-f7e2e341"]]);export{C as S};
