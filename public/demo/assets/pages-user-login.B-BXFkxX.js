import{N as e,r as a,v as o,o as s,T as t,U as n,V as r,W as i,X as l,d as c,a as u,b as p,c as d,e as f,w as m,f as g,g as h,K as v,k as y,l as _,n as b,u as w,x as k,p as x,t as C,h as P,Y as j,z as B,i as A,F as I,A as L,j as S,Z as T,_ as $,B as z}from"./index-BXs9N0aO.js";import{_ as U}from"./cl-topbar.CvzCs08H.js";import{_ as V}from"./cl-input.CAOkH06t.js";import{b as q,a as W,i as D}from"./cl-page.D0l32468.js";import{_ as M}from"./cl-text.FIltvNqU.js";import{_ as R}from"./cl-divider.bG88Jigs.js";import{_ as X}from"./logo.DsHqZPNN.js";import{u as F,_ as E}from"./_plugin-vue_export-helper.D4XvEQHf.js";import{u as N}from"./index.BeCewKBR.js";import{S as O}from"./sms-btn.DwP19pnX.js";import{_ as Y}from"./cl-checkbox.BVl_dMIM.js";import{c as Z}from"./cloneDeep.CYJ2asS6.js";import"./isBoolean.XkqdrK9A.js";function K(){const{platform:c}=e(),u=a("");async function p(){return new Promise((e=>{}))}function d(){return"micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)}const f={appId:""};return o((()=>{p()})),s((()=>{d()&&t.user.comm.wxMpConfig({url:`${location.origin}${location.pathname}`}).then((e=>{n.config({debug:r.app.wx.debug,jsApiList:["chooseWXPay"],...e}),Object.assign(f,e)}))})),{code:u,getCode:p,isWxBrowser:d,hasApp:function(){return!0},downloadApp:function(){},mpConfig:f,mpAuth:function(){const e=encodeURIComponent(`${location.origin}${location.pathname}#/pages/user/login`),a=`https://open.weixin.qq.com/connect/oauth2/authorize?appid=${f.appId}&redirect_uri=${e}&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect`;location.href=a},mpLogin:async function(){return new Promise((e=>{const a=i("code"),o=l.get("mpCode");let s=window.location.href;s=s.replace(/(\?[^#]*)#/,"#"),window.history.replaceState({},"",s),a!=o?(l.set("mpCode",a),e(a)):e(null)}))},mpPay:async function(e){return new Promise(((a,o)=>{if(!d())return o({message:"请在微信浏览器中打开"});n.chooseWXPay({...e,timestamp:e.timeStamp,success(){a()},complete(e){if("chooseWXPay:cancel"===e.errMsg)o({message:"已取消支付"});else o({message:"支付失败"})}})}))},miniLogin:async function(){return new Promise(((e,a)=>{uni["mac"===c?"getUserInfo":"getUserProfile"]({lang:"zh_CN",desc:"授权信息仅用于用户登录",success({iv:a,encryptedData:o,signature:s,rawData:t}){function n(){e({iv:a,encryptedData:o,signature:s,rawData:t,code:u.value})}uni.checkSession({success(){n()},fail(){p().then(n)}})},fail(e){console.error(e),p(),a({message:"登录授权失败"})}})}))},miniPay:function(e){return new Promise(((a,o)=>{uni.requestPayment({provider:"wxpay",...e,success(){a()},fail(){o({message:"已取消支付"})}})}))},appLogin:function(){let e,a;return new Promise(((o,s)=>{plus.oauth.getServices((t=>{e=t,Object.keys(e).some((o=>{"weixin"==e[o].id&&(a=e[o])})),a.authorize(o,s)}),s)}))},appPay:function(e){return new Promise(((a,o)=>{uni.requestPayment({provider:"wxpay",orderInfo:e,success(){a()},fail(){o({message:"已取消支付"})}})}))}}}const G=E(c({__name:"agree-btn",setup(e,{expose:o}){const{router:s}=F(),t=N(),n=a(!1);function r(e,a){s.push({path:"/pages/user/doc",query:{title:e,key:a}})}return o({check:function(){return n.value||t.showToast("请先勾选同意后再进行登录"),n.value}}),(e,a)=>{const o=y,s=_,t=u(p("cl-checkbox"),Y);return d(),f(t,{size:34,modelValue:n.value,"onUpdate:modelValue":a[2]||(a[2]=e=>n.value=e),round:""},{default:m((()=>[g(s,{class:"agree-btn"},{default:m((()=>[h(" 已阅读并同意 "),g(o,{onClick:a[0]||(a[0]=v((e=>r("用户协议","userAgreement")),["stop"]))},{default:m((()=>[h("用户协议")])),_:1}),h(" 和 "),g(o,{onClick:a[1]||(a[1]=v((e=>r("隐私政策","privacyPolicy")),["stop"]))},{default:m((()=>[h("隐私政策")])),_:1})])),_:1})])),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-dca0435a"]]),H=E(c({__name:"login",setup(e){const{service:o,router:t,refs:n,setRefs:i,storage:l}=F(),{user:c}=b(),v=w(),E=N(),Y=K(),H=a(!1),J=a(l.get("phone")||""),Q=a(),ee=a([{label:"通过手机登录",value:"phone",icon:"/pages/user/static/icon/phone.png",hidden:!1},{label:"通过微信登录",value:"wx",icon:"/pages/user/static/icon/wx.png",hidden:!0}]),ae=k((()=>{var e;let a=Z(ee.value);return Y.isWxBrowser()&&(a[1].hidden=!1),a=a.filter((e=>!e.hidden)),Q.value||(Q.value=null==(e=a[0])?void 0:e.value),a.filter((e=>e.value!=Q.value))}));async function oe(e,a){return o.user.login[e](a).then((async a=>{c.setToken(a),await c.get(),t.nextLogin(e)})).catch((e=>{E.showTips(e.message)}))}function se(e){e?ne((()=>{n.smsBtn.open()})):(l.set("phone",J.value),t.push({path:"/pages/user/captcha",query:{phone:J.value}}))}function te(){ne((async()=>{Y.mpAuth()}))}function ne(e){n.agreeBtn.check()&&e()}const re=x({error:"",check(){},login(){T({provider:"univerify",univerifyStyle:{authButton:{normalColor:"#6b69f8",highlightColor:"#6b69f8",disabledColor:"#73aaf5",textColor:"#ffffff",title:"一键登录",borderRadius:"12px"},privacyTerms:{defaultCheckBoxState:!0,textColor:"#BBBBBB",termsColor:"#5496E3",prefix:"我已阅读并同意",suffix:"并使用本机号码登录",privacyItems:[{url:`${r.baseUrl}/app/base/comm/html?key=userAgreement`,title:"用户协议"},{url:`${r.baseUrl}/app/base/comm/html?key=privacyPolicy`,title:"隐私政策"}]}},async success(e){await oe("uniPhone",{appId:$.appid,...e.authResult}),uni.closeAuthView()},fail(){re.error&&E.showToast(re.error)}})}});return re.check(),s((()=>{Y.mpLogin().then((async e=>{e&&(E.showLoading(),await oe("mp",{code:e}),E.hideLoading())}))})),(e,a)=>{const o=u(p("cl-topbar"),U),s=z,t=y,n=_,r=u(p("cl-input"),V),l=u(p("cl-button"),q),c=u(p("cl-text"),M),b=u(p("cl-divider"),R),w=u(p("cl-page"),W);return d(),f(w,{"background-color":"#fff"},{default:m((()=>[g(o,{border:!1,"background-color":"transparent"}),g(n,{class:"page-login"},{default:m((()=>[g(n,{class:"logo"},{default:m((()=>[g(s,{src:X,mode:"aspectFill"}),g(t,null,{default:m((()=>[h(C(P(v).info.name),1)])),_:1})])),_:1}),j("div",{class:"container"},[g(n,{class:B(["mode",[`is-${Q.value}`]])},{default:m((()=>["phone"==Q.value?(d(),A(I,{key:0},[g(t,{class:"label"},{default:m((()=>[h("手机号登录")])),_:1}),g(n,{class:"phone"},{default:m((()=>[g(t,null,{default:m((()=>[h("+86")])),_:1}),g(r,{modelValue:J.value,"onUpdate:modelValue":a[0]||(a[0]=e=>J.value=e),type:"number",placeholder:"请填写手机号码",border:!1,maxlength:11,"font-size":30,"background-color":"transparent"},null,8,["modelValue"])])),_:1}),g(O,{ref:P(i)("smsBtn"),phone:J.value,onSuccess:a[1]||(a[1]=e=>se(!1))},{default:m((({disabled:e,btnText:a})=>[g(l,{fill:"",type:"primary",height:90,"font-size":30,disabled:e,onClick:se},{default:m((()=>[h(C(a),1)])),_:2},1032,["disabled"])])),_:1},8,["phone"])],64)):"wx"==Q.value?(d(),f(l,{key:1,type:"primary",fill:"",height:90,"font-size":30,loading:H.value,onClick:te},{default:m((()=>[h(" 微信一键登录 ")])),_:1},8,["loading"])):L("",!0),g(n,{class:"agree"},{default:m((()=>[g(G,{ref:P(i)("agreeBtn")},null,512)])),_:1})])),_:1},8,["class"])]),P(D)(ae.value)?L("",!0):(d(),f(n,{key:0,class:"other"},{default:m((()=>[g(b,{width:"400rpx","background-color":"#ffffff"},{default:m((()=>[g(c,{color:"#ccc",value:"其他登录方式"})])),_:1}),g(n,{class:"platform"},{default:m((()=>[(d(!0),A(I,null,S(ae.value,((e,a)=>(d(),f(n,{class:"platform__item",key:a,onClick:a=>function(e){e.onClick?e.onClick():Q.value=e.value}(e)},{default:m((()=>[e.icon?(d(),f(s,{key:0,src:e.icon,mode:"aspectFit"},null,8,["src"])):L("",!0),g(t,null,{default:m((()=>[h(C(e.label),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}))])),_:1})])),_:1})}}}),[["__scopeId","data-v-2b5a7685"]]);export{H as default};
