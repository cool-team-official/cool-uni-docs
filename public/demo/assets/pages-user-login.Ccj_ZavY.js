import{R as e,b as a,r as o,A as s,o as t,X as l,Y as n,Z as r,_ as i,$ as c,d as u,e as p,f as d,g as m,h as f,w as h,j as g,k as v,t as b,O as _,x as y,v as w,a as k,u as x,B as C,c as j,a0 as P,a1 as B,l as $,a2 as A,D as U,n as V,F as T,E as z,p as I,q as L,a3 as S,a4 as q}from"./index-Dlau7bkh.js";import{_ as D}from"./cl-topbar.CSdNb0-k.js";import{_ as N}from"./cl-input.Cxen37Qp.js";import{c as R,a as W,b as M,i as X}from"./cl-page.C3y_EXfh.js";import{_ as E}from"./cl-text.DUw3LhC2.js";import{_ as F}from"./cl-divider.rjgXFhwx.js";import{_ as O}from"./cl-avatar.CmFnm4H6.js";import{_ as Y}from"./cl-list-item.DKPqGbx2.js";import{_ as Z}from"./cl-list.CDo1qXYQ.js";import{_ as G}from"./logo.BkEKDfb4.js";import{u as H}from"./index.AbH2Jzti.js";import{u as J}from"./index.Dnq2RgDG.js";import{S as K}from"./sms-btn.BVBrOTE7.js";import{_ as Q}from"./cl-checkbox.CaJhdFam.js";import{_ as ee}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{c as ae}from"./cloneDeep.B3v6UXnm.js";import"./isBoolean.Bco7Ljdy.js";function oe(){const{platform:u}=e(),{t:p}=a(),d=o("");async function m(){return new Promise((e=>{}))}function f(){return"micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)}const h={appId:""};return s((()=>{m()})),t((()=>{f()&&l.user.comm.wxMpConfig({url:`${location.origin}${location.pathname}`}).then((e=>{n.config({debug:r.app.wx.debug,jsApiList:["chooseWXPay"],...e}),Object.assign(h,e)}))})),{code:d,getCode:m,isWxBrowser:f,hasApp:function(){return!0},downloadApp:function(){},mpConfig:h,mpAuth:function(){const e=encodeURIComponent(`${location.origin}${location.pathname}#/pages/user/login`),a=`https://open.weixin.qq.com/connect/oauth2/authorize?appid=${h.appId}&redirect_uri=${e}&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect`;location.href=a},mpLogin:async function(){return new Promise((e=>{const a=i("code"),o=c.get("mpCode");let s=window.location.href;s=s.replace(/(\?[^#]*)#/,"#"),window.history.replaceState({},"",s),a!=o?(c.set("mpCode",a),e(a)):e(null)}))},mpPay:async function(e){return new Promise(((a,o)=>{if(!f())return o({message:p("请在微信浏览器中打开")});n.chooseWXPay({...e,timestamp:e.timeStamp,success(){a()},complete(e){if("chooseWXPay:cancel"===e.errMsg)o({message:p("已取消支付")});else o({message:p("支付失败")})}})}))},miniLogin:async function(){return new Promise(((e,a)=>{uni["mac"===u?"getUserInfo":"getUserProfile"]({lang:"zh_CN",desc:p("授权信息仅用于用户登录"),success({iv:a,encryptedData:o,signature:s,rawData:t}){function l(){e({iv:a,encryptedData:o,signature:s,rawData:t,code:d.value})}uni.checkSession({success(){l()},fail(){m().then(l)}})},fail(e){console.error(e),m(),a({message:p("登录授权失败")})}})}))},miniPay:function(e){return new Promise(((a,o)=>{uni.requestPayment({provider:"wxpay",...e,success(){a()},fail(){o({message:p("已取消支付")})}})}))},appLogin:function(){let e,a;return new Promise(((o,s)=>{plus.oauth.getServices((t=>{e=t,Object.keys(e).some((o=>{"weixin"==e[o].id&&(a=e[o])})),a.authorize(o,s)}),s)}))},appPay:function(e){return new Promise(((a,o)=>{uni.requestPayment({provider:"wxpay",orderInfo:e,success(){a()},fail(){o({message:p("已取消支付")})}})}))}}}const se=u({name:"undefined"}),te=ee(u({...se,setup(e,{expose:s}){const{router:t}=H(),l=J(),{t:n}=a(),r=o(!1);function i(e,a){t.push({path:"/pages/user/doc",query:{title:e,key:a}})}return s({check:function(){return r.value||l.showToast(n("请先勾选同意后再进行登录")),r.value}}),(e,a)=>{const o=y,s=w,t=p(d("cl-checkbox"),Q);return m(),f(t,{size:34,modelValue:r.value,"onUpdate:modelValue":a[2]||(a[2]=e=>r.value=e),round:""},{default:h((()=>[g(s,{class:"agree-btn"},{default:h((()=>[v(b(e.$t("已阅读并同意"))+" ",1),g(o,{onClick:a[0]||(a[0]=_((e=>i("用户协议","userAgreement")),["stop"]))},{default:h((()=>[v(b(e.$t("用户协议")),1)])),_:1}),v(" "+b(e.$t("和"))+" ",1),g(o,{onClick:a[1]||(a[1]=_((e=>i("隐私政策","privacyPolicy")),["stop"]))},{default:h((()=>[v(b(e.$t("隐私政策")),1)])),_:1})])),_:1})])),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-7dcba33e"]]),le=u({name:"undefined"}),ne=ee(u({...le,setup(e){const{service:s,router:l,refs:n,setRefs:i,storage:c,upload:u}=H(),{user:_}=k(),Q=x(),ee=J(),se=oe(),{t:le}=a(),ne=o(!1),re=o(c.get("phone")||""),ie=o(""),ce=o(),ue=o([{label:le("通过手机登录"),value:"phone",icon:"/pages/user/static/icon/phone.png",hidden:!1},{label:le("通过微信登录"),value:"wx",icon:"/pages/user/static/icon/wx.png",hidden:!0}]),pe=C((()=>{var e;let a=ae(ue.value);return se.isWxBrowser()&&(a[1].hidden=!1),a=a.filter((e=>!e.hidden)),ce.value||(ce.value=null==(e=a[0])?void 0:e.value),a.filter((e=>e.value!=ce.value))}));async function de(e,a){ie.value=e,s.user.login[e](a).then((async e=>{_.setToken(e),await _.get(),be.check()})).catch((e=>{ee.showTips(e.message),se.getCode()}))}function me(){l.nextLogin(ie.value)}function fe(e){e?ge((()=>{n.smsBtn.open()})):(c.set("phone",re.value),l.push({path:"/pages/user/captcha",query:{phone:re.value}}))}function he(){ge((async()=>{se.mpAuth()}))}function ge(e){n.agreeBtn.check()&&e()}const ve=j({error:"",check(){},login(){P({provider:"univerify",univerifyStyle:{authButton:{normalColor:"#6b69f8",highlightColor:"#6b69f8",disabledColor:"#73aaf5",textColor:"#ffffff",title:le("一键登录"),borderRadius:"12px"},privacyTerms:{defaultCheckBoxState:!0,textColor:"#BBBBBB",termsColor:"#5496E3",prefix:le("我已阅读并同意"),suffix:le("并使用本机号码登录"),privacyItems:[{url:`${r.baseUrl}/app/base/comm/html?key=userAgreement`,title:le("用户协议")},{url:`${r.baseUrl}/app/base/comm/html?key=privacyPolicy`,title:le("隐私政策")}]}},async success(e){await de("uniPhone",{appId:B.appid,...e.authResult}),uni.closeAuthView()},fail(){ve.error&&ee.showToast(ve.error)}})}});ve.check();const be=j({visible:!1,form:{avatarUrl:"",nickName:""},check(){var e;"mini"==ie.value&&"微信用户"==(null==(e=_.info)?void 0:e.nickName)?be.open():me()},open(){be.visible=!0},close(){be.visible=!1},onClose(){me()},uploadAvatar(e){u({path:e.detail.avatarUrl}).then((e=>{be.form.avatarUrl=e})).catch((e=>{ee.showToast(e.message)}))},save:()=>be.form.avatarUrl?be.form.nickName?(_.update(be.form),void be.close()):ee.showToast(le("请输入昵称")):ee.showToast(le("请上传头像"))});return t((()=>{se.mpLogin().then((async e=>{e&&(ee.showLoading(),await de("mp",{code:e}),ee.hideLoading())}))})),(e,a)=>{const o=p(d("cl-topbar"),D),s=L,t=y,l=w,n=p(d("cl-input"),N),r=p(d("cl-button"),R),c=p(d("cl-text"),E),u=p(d("cl-divider"),F),_=p(d("cl-avatar"),O),k=S,x=p(d("cl-list-item"),Y),C=q,j=p(d("cl-list"),Z),P=p(d("cl-popup"),W),B=p(d("cl-page"),M);return m(),f(B,{"background-color":"#fff"},{default:h((()=>[g(o,{border:!1,"background-color":"transparent"}),g(l,{class:"page-login"},{default:h((()=>[g(l,{class:"logo"},{default:h((()=>[g(s,{src:G,mode:"aspectFill"}),g(t,null,{default:h((()=>[v(b($(Q).info.name),1)])),_:1})])),_:1}),A("div",{class:"container"},[g(l,{class:U(["mode",[`is-${ce.value}`]])},{default:h((()=>["phone"==ce.value?(m(),V(T,{key:0},[g(t,{class:"label"},{default:h((()=>[v(b($(le)("手机号登录")),1)])),_:1}),g(l,{class:"phone"},{default:h((()=>[g(t,null,{default:h((()=>[v("+86")])),_:1}),g(n,{modelValue:re.value,"onUpdate:modelValue":a[0]||(a[0]=e=>re.value=e),type:"number",placeholder:$(le)("请填写手机号码"),border:!1,maxlength:11,"font-size":30,"background-color":"transparent"},null,8,["modelValue","placeholder"])])),_:1}),g(K,{ref:$(i)("smsBtn"),phone:re.value,onSuccess:a[1]||(a[1]=e=>fe(!1))},{default:h((({disabled:e,btnText:a})=>[g(r,{custom:"",type:"primary",height:90,"font-size":30,disabled:e,onClick:fe},{default:h((()=>[v(b(a),1)])),_:2},1032,["disabled"])])),_:1},8,["phone"])],64)):"wx"==ce.value?(m(),f(r,{key:1,custom:"",type:"primary",height:90,"font-size":30,loading:ne.value,onClick:he},{default:h((()=>[v(b($(le)("微信一键登录")),1)])),_:1},8,["loading"])):z("",!0),g(l,{class:"agree"},{default:h((()=>[g(te,{ref:$(i)("agreeBtn")},null,512)])),_:1})])),_:1},8,["class"])]),$(X)(pe.value)?z("",!0):(m(),f(l,{key:0,class:"other"},{default:h((()=>[g(u,{width:"400rpx","background-color":"#ffffff"},{default:h((()=>[g(c,{color:"#ccc",value:$(le)("其他登录方式")},null,8,["value"])])),_:1}),g(l,{class:"platform"},{default:h((()=>[(m(!0),V(T,null,I(pe.value,((e,a)=>(m(),f(l,{class:"platform__item",key:a,onClick:a=>function(e){e.onClick?e.onClick():ce.value=e.value}(e)},{default:h((()=>[e.icon?(m(),f(s,{key:0,src:e.icon,mode:"aspectFit"},null,8,["src"])):z("",!0),g(t,null,{default:h((()=>[v(b(e.label),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}))])),_:1}),g(P,{modelValue:be.visible,"onUpdate:modelValue":a[3]||(a[3]=e=>be.visible=e),direction:"bottom","border-radius":[32,32,0,0],"show-close-btn":"",onClose:be.onClose},{default:h((()=>[A("div",{class:"edit-popup"},[g(c,{block:"",bold:"",size:32},{default:h((()=>[v(b($(le)("获取你的头像、昵称")),1)])),_:1}),g(c,{block:"",margin:[24,0,50,0],color:"info"},{default:h((()=>[v(b($(le)("用于向用户提供有辨识度的界面")),1)])),_:1}),g(j,{margin:[0,-12,60,-12],border:!1},{default:h((()=>[g(x,{label:$(le)("头像"),"arrow-icon":!1},{default:h((()=>[g(k,{class:"avatar","open-type":"chooseAvatar",onChooseavatar:be.uploadAvatar},{default:h((()=>[g(_,{round:"",size:80,src:be.form.avatarUrl,margin:[0,1,0,0]},null,8,["src"])])),_:1},8,["onChooseavatar"])])),_:1},8,["label"]),g(x,{label:$(le)("昵称"),"arrow-icon":!1},{default:h((()=>[g(C,{class:"name",modelValue:be.form.nickName,"onUpdate:modelValue":a[2]||(a[2]=e=>be.form.nickName=e),type:"nickname",placeholder:$(le)("请填写昵称、限16个字符或汉字"),maxlength:"16"},null,8,["modelValue","placeholder"])])),_:1},8,["label"])])),_:1}),g(r,{fill:"",type:"primary",height:90,"font-size":30,onClick:be.save},{default:h((()=>[v(b($(le)("保存")),1)])),_:1},8,["onClick"])])])),_:1},8,["modelValue","onClose"])])),_:1})}}}),[["__scopeId","data-v-cdce2d2b"]]);export{ne as default};
