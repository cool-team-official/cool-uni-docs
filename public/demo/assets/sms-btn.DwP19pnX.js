import{b as e,_ as a,c as s,d as o}from"./cl-page.D0l32468.js";import{d as t,p as l,r as n,x as i,a as c,b as d,c as u,e as r,w as p,R as f,f as h,g as m,t as g,h as b,l as v,B as _}from"./index-BXs9N0aO.js";import{_ as w}from"./cl-text.FIltvNqU.js";import{_ as x}from"./cl-input.CAOkH06t.js";import{u as z,_ as y}from"./_plugin-vue_export-helper.D4XvEQHf.js";import{u as C}from"./index.BeCewKBR.js";const k=y(t({__name:"sms-btn",props:{phone:String,type:String,height:Number,fontSize:Number,size:String,border:{type:Boolean,default:!0},plain:Boolean},emits:["success"],setup(t,{expose:y,emit:k}){const I=t,j=k,{service:S,refs:T,setRefs:V}=z(),B=C(),F=l({visible:!1,loading:!1,sending:!1,img:""}),$=n(0),N=i((()=>$.value>0||!I.phone)),R=i((()=>$.value>0?`${$.value}s后重新获取`:"获取验证码")),U=l({code:"",captchaId:""});function E(){function e(){$.value--,$.value<1&&clearInterval(a)}$.value=60;const a=setInterval(e,1e3);e()}async function Y(){U.code?(F.sending=!0,await S.user.login.smsCode({phone:I.phone,...U}).then((()=>{B.showToast("短信已发送，请查收"),E(),A(),j("success")})).catch((e=>{B.showToast(e.message),Z()})),F.sending=!1):B.showToast("请填写验证码")}async function Z(){D(),F.loading=!0,await S.user.login.captcha({type:"png",color:"#000000",phone:I.phone}).then((e=>{U.captchaId=e.captchaId,F.img=e.data})).catch((e=>{B.showToast(e.message)})),F.loading=!1}function q(){I.phone&&(/^(?:(?:\+|00)86)?1[3-9]\d{9}$/.test(I.phone)?(F.visible=!0,Z()):B.showToast("请填写正确的手机号格式"))}function A(){F.visible=!1,D()}function D(){U.code="",U.captchaId=""}return y({open:q,send:Y,getCaptcha:Z,startCountdown:E}),(l,n)=>{const i=c(d("cl-button"),e),z=c(d("cl-text"),w),y=c(d("cl-icon"),a),C=v,k=c(d("cl-input"),x),I=_,j=c(d("cl-loading-mask"),s),S=c(d("cl-popup"),o);return u(),r(C,{class:"sms-btn"},{default:p((()=>[f(l.$slots,"default",{disabled:N.value,countdown:$.value,btnText:R.value},(()=>[h(i,{border:!1,"background-color":"transparent",color:"#FE6B03",height:t.height,"font-size":t.fontSize,fill:"",size:t.size,disabled:N.value,onClick:q},{default:p((()=>[m(g(R.value),1)])),_:1},8,["height","font-size","size","disabled"])]),!0),h(S,{modelValue:F.visible,"onUpdate:modelValue":n[1]||(n[1]=e=>F.visible=e),ref:b(V)("popup"),padding:40,"border-radius":"24rpx"},{default:p((()=>[h(j,{loading:F.loading},{default:p((()=>[h(C,{class:"sms-popup"},{default:p((()=>[h(C,{class:"head"},{default:p((()=>[h(z,{bold:"",size:28,value:"获取短信验证码"}),h(y,{size:32,name:"close",onClick:A})])),_:1}),h(C,{class:"row"},{default:p((()=>{var e;return[h(k,{type:"number",modelValue:U.code,"onUpdate:modelValue":n[0]||(n[0]=e=>U.code=e),placeholder:"验证码",maxlength:4,height:70,clearable:!1,focus:null==(e=b(T).popup)?void 0:e.isFocus,border:!1,"background-color":"#f7f7f7",onConfirm:Y},null,8,["modelValue","focus"]),h(I,{src:F.img,mode:"aspectFit",onClick:Z},null,8,["src"])]})),_:1}),h(i,{type:"primary",fill:"",disabled:!U.code,loading:F.sending,height:70,onClick:Y},{default:p((()=>[m(" 发送短信 ")])),_:1},8,["disabled","loading"])])),_:1})])),_:1},8,["loading"])])),_:1},8,["modelValue"])])),_:3})}}}),[["__scopeId","data-v-f7e2e341"]]);export{k as S};
